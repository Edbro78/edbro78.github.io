<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bernt- og Edvards løpekalkulator 2025</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'indigo-start': '#5a67d8',
                        'indigo-end': '#818cf8',
                        'purple-start': '#a78bfa',
                        'purple-end': '#d8b4fe',
                    }
                }
            }
        }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        .results-grid { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 1rem; }
        @media (min-width: 768px) { .results-grid { grid-template-columns: repeat(3, minmax(0, 1fr)); } }
        .prediction-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 0.75rem; }
        .result-item svg.main-icon { width: 2em; height: 2em; margin-bottom: 0.5rem; stroke: url(#iconGradient); }
        .section-header svg { width: 1.5em; height: 1.5em; margin-right: 0.5rem; color: #4f46e5; }
        .hidden-gradient-defs { position: absolute; width: 0; height: 0; overflow: hidden; }
        .toggle-checkbox:checked { right: 0; border-color: #4f46e5; }
        .toggle-checkbox:checked + .toggle-label { background-color: #4f46e5; }
        .toggle-checkbox { appearance: none; display: inline-block; width: 2em; height: 1em; background-color: #e5e7eb; border-radius: 9999px; border: 1px solid #d1d5db; position: relative; cursor: pointer; transition: background-color 0.2s ease-in-out; vertical-align: middle; }
        .toggle-checkbox::before { content: ""; position: absolute; left: 1px; top: 1px; width: calc(1em - 4px); height: calc(1em - 4px); background-color: white; border-radius: 50%; transition: transform 0.2s ease-in-out; }
        .toggle-checkbox:checked::before { transform: translateX(1em); }
        .toggle-label { display: inline-block; cursor: pointer; color: #374151; margin-left: 0.5rem; vertical-align: middle; }
        .interval-info p { margin-bottom: 0.5rem; }
        .interval-info strong { color: #4f46e5; }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-100 via-blue-50 to-purple-100 min-h-screen flex items-start justify-center p-4 sm:p-6 lg:p-8">

    <svg class="hidden-gradient-defs">
      <defs>
        <linearGradient id="iconGradient" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" style="stop-color:#6366f1; stop-opacity:1" />
          <stop offset="100%" style="stop-color:#a78bfa; stop-opacity:1" />
        </linearGradient>
      </defs>
    </svg>

    <div class="calculator-container bg-white p-6 sm:p-8 rounded-xl shadow-xl w-full max-w-3xl">
        <h1 class="text-2xl sm:text-3xl font-bold text-center text-gray-800 mb-6 sm:mb-8">Bernt og Edvards løpekalkulator</h1>

        <form id="calculator-form" class="space-y-5">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="md:col-span-2 grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="distance-select" class="block text-sm font-medium text-gray-700 mb-1">Velg/oppgi distanse:</label>
                        <select id="distance-select" name="distance-select" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-base transition duration-150 ease-in-out">
                            <option value="preset" selected>-- Velg forhåndsinnstilt --</option>
                            <option value="0.8">800 meter</option>
                            <option value="1.5">1500 meter</option>
                            <option value="3">3000 meter</option>
                            <option value="5">5 km</option>
                            <option value="10">10 km</option>
                            <option value="21.0975">Halvmaraton (21.0975 km)</option>
                            <option value="42.195">Maraton (42.195 km)</option>
                            <option value="custom">Annen distanse (km)</option>
                        </select>
                    </div>
                    <div id="custom-distance-container" class="hidden">
                        <label for="custom-distance" class="block text-sm font-medium text-gray-700 mb-1">Egendefinert (km):</label>
                        <input type="number" id="custom-distance" name="custom-distance" step="0.001" min="0.01" placeholder="f.eks. 7.5" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-base transition duration-150 ease-in-out">
                    </div>
                </div>
                <div>
                    <label for="elevation" class="block text-sm font-medium text-gray-700 mb-1">Høydemeter (m):</label>
                    <input type="number" id="elevation" name="elevation" min="0" step="1" placeholder="f.eks. 300" value="0" inputmode="numeric" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-base transition duration-150 ease-in-out">
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Sluttid:</label>
                <div class="grid grid-cols-3 gap-3">
                    <div>
                        <label for="hours" class="text-xs text-gray-500 block text-center mb-1">Timer</label>
                        <input type="number" id="hours" name="hours" placeholder="0" value="0" min="0" inputmode="numeric" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-center text-base transition duration-150 ease-in-out">
                    </div>
                    <div>
                        <label for="minutes" class="text-xs text-gray-500 block text-center mb-1">Minutter</label>
                        <input type="number" id="minutes" name="minutes" placeholder="00" value="00" min="0" max="59" inputmode="numeric" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-center text-base transition duration-150 ease-in-out">
                    </div>
                    <div>
                        <label for="seconds" class="text-xs text-gray-500 block text-center mb-1">Sekunder</label>
                        <input type="number" id="seconds" name="seconds" placeholder="00" value="00" min="0" max="59" step="0.01" inputmode="decimal" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-center text-base transition duration-150 ease-in-out">
                    </div>
                </div>
            </div>
             <div class="flex items-center justify-center pt-2">
                 <input type="checkbox" id="negative-split-toggle" class="toggle-checkbox">
                 <label for="negative-split-toggle" class="toggle-label text-sm font-medium text-gray-700">Planlegg med Negativ Splitt (2%)?</label>
                 <span class="ml-2 text-gray-400 cursor-pointer" title="Første halvdel 2% saktere, andre halvdel 2% raskere enn snittfart for måltid.">ⓘ</span>
             </div>
            <button type="submit" class="w-full bg-gradient-to-r from-indigo-start to-indigo-end hover:from-indigo-600 hover:to-indigo-700 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-300 ease-in-out text-lg transform hover:-translate-y-0.5">
                Beregn Løpsdata
            </button>
        </form>

        <div id="error-message" class="mt-4 text-red-600 font-medium text-center min-h-[20px]"></div>

        <div id="results-section" class="mt-8 space-y-6 hidden">

            <div class="bg-gradient-to-br from-gray-50 to-gray-100 p-5 rounded-lg shadow-md border border-gray-200">
                 <h2 class="section-header text-xl font-semibold text-gray-800 mb-5 text-center flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"> <path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 0 1 1.04 0l2.125 5.111a.563.563 0 0 0 .475.31h5.518a.562.562 0 0 1 .321.988l-4.204 3.602a.563.563 0 0 0-.182.557l1.285 5.385a.562.562 0 0 1-.84.61l-4.725-2.885a.562.562 0 0 0-.586 0L6.982 20.54a.562.562 0 0 1-.84-.61l1.285-5.386a.562.562 0 0 0-.182-.557l-4.204-3.602a.562.562 0 0 1 .321-.988h5.518a.563.563 0 0 0 .475-.31L11.48 3.5Z" /></svg>
                    Hovedresultater
                 </h2>
                 <div class="results-grid">
                    <div class="result-item bg-white p-4 rounded-lg shadow-sm border border-gray-100 text-center flex flex-col items-center transition duration-200 hover:shadow-md">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" class="main-icon"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" /></svg>
                        <span class="text-sm text-gray-500 block font-medium">Gj.snitt Pace</span>
                        <strong id="pace-result" class="text-lg sm:text-xl font-bold text-indigo-600 block"></strong>
                    </div>
                     <div class="result-item bg-white p-4 rounded-lg shadow-sm border border-gray-100 text-center flex flex-col items-center transition duration-200 hover:shadow-md">
                         <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" class="main-icon"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18 9 11.25l4.306 4.306a11.95 11.95 0 0 1 5.814-5.518l2.74-1.22m0 0-5.94-2.281m5.94 2.28-2.28 5.941" /></svg>
                        <span class="text-sm text-gray-500 block font-medium">Justert Pace (GAP)</span>
                        <strong id="adjusted-pace-result" class="text-lg sm:text-xl font-bold text-indigo-600 block"></strong>
                        <span id="adjusted-pace-note" class="text-xs text-gray-400 block mt-1"></span>
                    </div>
                    <div class="result-item bg-white p-4 rounded-lg shadow-sm border border-gray-100 text-center flex flex-col items-center transition duration-200 hover:shadow-md">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" class="main-icon"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75Z" /></svg>
                        <span class="text-sm text-gray-500 block font-medium">Gj.snitt Hastighet</span>
                        <strong id="speed-result" class="text-lg sm:text-xl font-bold text-indigo-600 block"></strong>
                    </div>
                    <div class="result-item bg-white p-4 rounded-lg shadow-sm border border-gray-100 text-center flex flex-col items-center transition duration-200 hover:shadow-md">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" class="main-icon"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg>
                        <span class="text-sm text-gray-500 block font-medium">400m Rundetid (Snitt)</span>
                        <strong id="lap-time-result" class="text-lg sm:text-xl font-bold text-indigo-600 block"></strong>
                    </div>
                     <div class="result-item bg-white p-4 rounded-lg shadow-sm border border-gray-100 text-center flex flex-col items-center transition duration-200 hover:shadow-md">
                         <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" class="main-icon"> <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 6.75h7.5M8.25 12h7.5m-7.5 5.25h7.5M3 10.5a2.25 2.25 0 1 1 4.5 0 2.25 2.25 0 0 1-4.5 0Zm12.75 4.5a2.25 2.25 0 1 1 4.5 0 2.25 2.25 0 0 1-4.5 0Zm-4.5-4.5a2.25 2.25 0 1 1 4.5 0 2.25 2.25 0 0 1-4.5 0Z" /></svg>
                        <span class="text-sm text-gray-500 block font-medium">800m Tid (v/GAP)</span>
                        <strong id="time-800m-result" class="text-lg sm:text-xl font-bold text-indigo-600 block"></strong>
                    </div>
                     <div class="result-item bg-white p-4 rounded-lg shadow-sm border border-gray-100 text-center flex flex-col items-center transition duration-200 hover:shadow-md">
                         <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" class="main-icon"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 15.75l-2.489-2.489m0 0a3.375 3.375 0 1 0-4.773-4.773 3.375 3.375 0 0 0 4.774 4.774ZM21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg>
                        <span class="text-sm text-gray-500 block font-medium">200m Tid (v/GAP)</span>
                        <strong id="time-200m-result" class="text-lg sm:text-xl font-bold text-indigo-600 block"></strong>
                    </div>
                </div>
                <p class="text-xs text-gray-500 text-center mt-4">GAP = Justert Pace (10hm ≈ 100m flatt). 800/200m tid er beregnet direkte fra GAP. Andre estimater bruker Riegel.</p>
                 <div id="negative-split-paces-info" class="mt-4 text-center hidden">
                     <p class="text-sm font-medium text-gray-700">Planlagt Pace (Negativ Splitt):</p>
                     <span class="text-sm text-gray-600">1. Halvdel: <strong id="pace-first-half" class="text-indigo-700"></strong>/km</span> |
                     <span class="text-sm text-gray-600">2. Halvdel: <strong id="pace-second-half" class="text-indigo-700"></strong>/km</span>
                 </div>
            </div>

            <div id="splits-container" class="bg-gradient-to-br from-gray-50 to-gray-100 p-5 rounded-lg shadow-md border border-gray-200">
                 <h2 id="splits-title" class="section-header text-xl font-semibold text-gray-800 mb-4 text-center flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 12h16.5m-16.5 3.75h16.5M3.75 19.5h16.5M5.625 4.5h12.75a1.125 1.125 0 0 1 0 2.25H5.625a1.125 1.125 0 0 1 0-2.25Z" /></svg>
                    <span id="splits-title-text">Estimerte Splittider (per km)</span>
                 </h2>
                 <div id="splits-header" class="text-center mb-3 grid grid-cols-3 gap-2 px-2">
                     <span class="text-xs text-left text-gray-500">Kilometer</span>
                     <span id="splits-col2-title" class="text-xs text-center text-indigo-700 font-medium">Faktisk Tid</span>
                     <span id="splits-col3-title" class="text-xs text-right text-purple-700 font-medium">Justert Tid (GAP)</span>
                 </div>
                 <div id="splits-list" class="max-h-60 overflow-y-auto space-y-2 pr-2"></div>
                 <p id="splits-note" class="text-xs text-gray-500 text-center mt-3 hidden">Løpsplan basert på 2% negativ splitt.</p>
            </div>

             <div class="bg-gradient-to-br from-gray-50 to-gray-100 p-5 rounded-lg shadow-md border border-gray-200">
                <h2 class="section-header text-xl font-semibold text-gray-800 mb-4 text-center flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 0 1 3 19.875v-6.75ZM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V8.625ZM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V4.125Z" /></svg>
                    Estimerte Tider (Andre Distanser)
                </h2>
                <p class="text-xs text-gray-500 text-center mb-3">Basert på din justerte innsats (GAP) og Riegel's formel ($T_2 = T_1 \times (D_2 / D_1)^{1.06}$). Kun estimater.</p>
                <div id="predictions-grid" class="prediction-grid"></div>
            </div>

             <div id="interval-section" class="bg-gradient-to-br from-gray-50 to-gray-100 p-5 rounded-lg shadow-md border border-gray-200">
                <h2 class="section-header text-xl font-semibold text-gray-800 mb-4 text-center flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99" />
                    </svg>
                    Hvordan løpe intervaller
                </h2>
                <div class="interval-info text-sm text-gray-700 space-y-2">
                    <p>Basert på din prestasjon (<span id="interval-basis-distance"></span> på <span id="interval-basis-time"></span>), er din estimerte halvmaratontid:</p>
                    <p class="text-center"><strong id="estimated-hm-time" class="text-lg"></strong> (tilsvarer <strong id="estimated-hm-pace"></strong>/km)</p>
                    <p>For 1000m intervaller anbefales det ofte å løpe ca. 5 sek/km raskere enn halvmaratonfart. Din anbefalte intervallfart er derfor:</p>
                    <p class="text-center"><strong id="recommended-interval-pace" class="text-lg"></strong>/km</p>
                    <p class="text-xs text-gray-500 text-center mt-3">(Dette er en generell anbefaling. Husk å lytte til kroppen og justere etter dagsform. Estimatet er basert på din justerte fart (GAP).)</p>
                </div>
            </div>

        </div> </div> <script>
        // --- DOM Elementer ---
        const form = document.getElementById('calculator-form');
        const distanceSelect = document.getElementById('distance-select');
        const customDistanceContainer = document.getElementById('custom-distance-container');
        const customDistanceInput = document.getElementById('custom-distance');
        const elevationInput = document.getElementById('elevation');
        const hoursInput = document.getElementById('hours');
        const minutesInput = document.getElementById('minutes');
        const secondsInput = document.getElementById('seconds');
        const negativeSplitToggle = document.getElementById('negative-split-toggle');
        const errorMessageDiv = document.getElementById('error-message');
        const resultsSection = document.getElementById('results-section');
        const paceResultSpan = document.getElementById('pace-result');
        const adjustedPaceResultSpan = document.getElementById('adjusted-pace-result');
        const adjustedPaceNoteSpan = document.getElementById('adjusted-pace-note');
        const lapTimeResultSpan = document.getElementById('lap-time-result');
        const speedResultSpan = document.getElementById('speed-result');
        const time800mResultSpan = document.getElementById('time-800m-result');
        const time200mResultSpan = document.getElementById('time-200m-result');
        const negativeSplitPacesInfoDiv = document.getElementById('negative-split-paces-info');
        const paceFirstHalfSpan = document.getElementById('pace-first-half');
        const paceSecondHalfSpan = document.getElementById('pace-second-half');
        const splitsContainer = document.getElementById('splits-container');
        const splitsTitle = document.getElementById('splits-title');
        const splitsTitleText = document.getElementById('splits-title-text');
        const splitsHeader = document.getElementById('splits-header');
        const splitsCol2Title = document.getElementById('splits-col2-title');
        const splitsCol3Title = document.getElementById('splits-col3-title');
        const splitsListDiv = document.getElementById('splits-list');
        const splitsNote = document.getElementById('splits-note');
        const intervalSectionDiv = document.getElementById('interval-section');
        const intervalBasisDistanceSpan = document.getElementById('interval-basis-distance');
        const intervalBasisTimeSpan = document.getElementById('interval-basis-time');
        const estimatedHmTimeSpan = document.getElementById('estimated-hm-time');
        const estimatedHmPaceSpan = document.getElementById('estimated-hm-pace');
        const recommendedIntervalPaceSpan = document.getElementById('recommended-interval-pace');
        const predictionsGridDiv = document.getElementById('predictions-grid');

        // --- Konstanter ---
        const RIEGEL_EXPONENT = 1.06;
        const ELEVATION_ADJUSTMENT_FACTOR = 10;
        const NEGATIVE_SPLIT_FACTOR = 0.02;
        const HALF_MARATHON_KM = 21.0975;
        const INTERVAL_PACE_ADJUSTMENT = 5;
        const PREDICTION_DISTANCES = [
            { name: '400 m', value: 0.4 }, { name: '1500 m', value: 1.5 }, { name: '3 km', value: 3 },
            { name: '5 km', value: 5 }, { name: '10 km', value: 10 }, { name: '15 km', value: 15 },
            { name: 'Halvmaraton', value: HALF_MARATHON_KM }, { name: 'Maraton', value: 42.195 }
        ];

        // --- Event Listeners ---
        form.addEventListener('submit', handleFormSubmit);
        distanceSelect.addEventListener('change', handleDistanceChange);
        negativeSplitToggle.addEventListener('change', () => {
            clearError();
            hideResults();
        });


        // --- Funksjoner ---

        function handleFormSubmit(event) {
            event.preventDefault();
            clearError(); // Fjern gamle feil først
            hideResults(); // Skjul gamle resultater

            // Bruk try-catch for generell feilhåndtering
            try {
                const distanceKm = getSelectedDistance();
                const elevationM = getElevation();
                const timeInputs = getTimeInputs();
                const useNegativeSplit = negativeSplitToggle.checked;

                // Validering sjekkes først
                if (!validateInputs(distanceKm, elevationM, timeInputs)) {
                    return; // Stopp hvis validering feiler
                }

                const totalSeconds = calculateTotalSeconds(timeInputs);
                // Sjekk total tid etter validering
                if (totalSeconds <= 0) {
                    showError("Total tid må være større enn null.");
                    return;
                }

                const calculations = performCalculations(distanceKm, elevationM, totalSeconds);

                // Sjekk for NaN eller Infinity i kritiske beregninger før visning
                if (!Number.isFinite(calculations.avgActualPaceSecondsPerKm) ||
                    !Number.isFinite(calculations.avgAdjustedPaceSecondsPerKm) ||
                    !Number.isFinite(calculations.speedKph)) {
                    showError("Kunne ikke beregne resultater. Sjekk inputverdiene.");
                    return;
                }


                displayResults(calculations, distanceKm, totalSeconds, elevationM > 0, useNegativeSplit, timeInputs);

            } catch (error) {
                console.error("En uventet feil oppstod:", error); // Logg feilen til konsollen for debugging
                showError("En uventet feil oppstod under beregningen."); // Vis generell feilmelding til brukeren
            }
        }

        function handleDistanceChange() {
            if (distanceSelect.value === 'custom') {
                customDistanceContainer.classList.remove('hidden');
                customDistanceInput.required = true;
                setTimeout(() => customDistanceInput.focus(), 0);
            } else {
                customDistanceContainer.classList.add('hidden');
                customDistanceInput.required = false;
                customDistanceInput.value = '';
            }
             clearError();
             hideResults();
        }

        function getSelectedDistance() {
            const selection = distanceSelect.value;
            if (selection === 'custom') return parseFloat(customDistanceInput.value);
            if (selection === 'preset') return NaN;
            return parseFloat(selection);
        }

        function getElevation() {
            const elevationStr = elevationInput.value.trim() || '0';
            return parseFloat(elevationStr);
        }

        function getTimeInputs() {
            return {
                hours: hoursInput.value.trim() || '0',
                minutes: minutesInput.value.trim() || '0',
                seconds: secondsInput.value.trim() || '0'
            };
        }

        function validateInputs(distanceKm, elevationM, timeInputs) {
             if (distanceSelect.value === 'preset') { showError("Vennligst velg en distanse."); return false; }
            if (isNaN(distanceKm) || distanceKm <= 0) { showError("Ugyldig eller manglende distanse."); return false; }
             if (isNaN(elevationM) || elevationM < 0) { showError("Ugyldig verdi for høydemeter."); return false; }
            const hours = parseFloat(timeInputs.hours);
            const minutes = parseFloat(timeInputs.minutes);
            const seconds = parseFloat(timeInputs.seconds);
            if (isNaN(hours) || isNaN(minutes) || isNaN(seconds)) { showError("Tidsfeltene må inneholde gyldige tall."); return false; }
            if (hours < 0 || minutes < 0 || seconds < 0) { showError("Tidsverdier kan ikke være negative."); return false; }
             if (minutes >= 60 || seconds >= 60) { showError("Minutter og sekunder må være under 60."); return false; }
            return true;
        }

        function calculateTotalSeconds(timeInputs) {
            const hours = parseFloat(timeInputs.hours);
            const minutes = parseFloat(timeInputs.minutes);
            const seconds = parseFloat(timeInputs.seconds);
            // Sikre at resultatet er et gyldig tall
            const total = (hours * 3600) + (minutes * 60) + seconds;
            return isNaN(total) ? 0 : total;
        }


        function performCalculations(distanceKm, elevationM, totalSeconds) {
            // Sikre at input er gyldig før beregning
             if (distanceKm <= 0 || totalSeconds <= 0) {
                 // Returner et objekt med null-verdier eller NaN for å indikere feil
                 return {
                     avgActualPaceSecondsPerKm: NaN, avgAdjustedPaceSecondsPerKm: NaN, speedKph: NaN,
                     avgLapTimeSeconds: NaN, equivalentFlatTotalSeconds: NaN,
                     paceFirstHalfSecsPerKm: NaN, paceSecondHalfSecsPerKm: NaN,
                     exact800mSeconds: NaN, exact200mSeconds: NaN,
                     estimatedHalfMarathonSeconds: NaN, estimatedHalfMarathonPaceSecsPerKm: NaN,
                     recommendedIntervalPaceSecondsPerKm: NaN
                 };
             }

            const totalHours = totalSeconds / 3600;
            const avgActualPaceSecondsPerKm = totalSeconds / distanceKm;
            const speedKph = distanceKm / totalHours; // totalHours vil være > 0 her
            const equivalentFlatDistanceKm = Math.max(0.001, distanceKm + (elevationM / 1000) * ELEVATION_ADJUSTMENT_FACTOR); // Unngå 0 eller negativ
            const avgAdjustedPaceSecondsPerKm = totalSeconds / equivalentFlatDistanceKm;
            const avgLapTimeSeconds = (avgActualPaceSecondsPerKm / 1000) * 400;
            const equivalentFlatTotalSeconds = avgAdjustedPaceSecondsPerKm * distanceKm;
            const paceFirstHalfSecsPerKm = avgActualPaceSecondsPerKm * (1 + NEGATIVE_SPLIT_FACTOR);
            const paceSecondHalfSecsPerKm = avgActualPaceSecondsPerKm * (1 - NEGATIVE_SPLIT_FACTOR);
            const exact800mSeconds = avgAdjustedPaceSecondsPerKm * 0.8;
            const exact200mSeconds = avgAdjustedPaceSecondsPerKm * 0.2;

            let estimatedHalfMarathonSeconds = 0;
            let estimatedHalfMarathonPaceSecsPerKm = 0;
            // Sjekk at basis for Riegel er gyldig
            if (equivalentFlatTotalSeconds > 0 && distanceKm > 0) {
                estimatedHalfMarathonSeconds = equivalentFlatTotalSeconds * Math.pow(HALF_MARATHON_KM / distanceKm, RIEGEL_EXPONENT);
                estimatedHalfMarathonPaceSecsPerKm = estimatedHalfMarathonSeconds / HALF_MARATHON_KM;
            }

            const recommendedIntervalPaceSecondsPerKm = estimatedHalfMarathonPaceSecsPerKm > 0
                ? estimatedHalfMarathonPaceSecsPerKm - INTERVAL_PACE_ADJUSTMENT
                : 0;

            // Returner alle beregnede verdier
            return {
                avgActualPaceSecondsPerKm, avgAdjustedPaceSecondsPerKm, speedKph,
                avgLapTimeSeconds, equivalentFlatTotalSeconds,
                paceFirstHalfSecsPerKm, paceSecondHalfSecsPerKm,
                exact800mSeconds, exact200mSeconds,
                estimatedHalfMarathonSeconds, estimatedHalfMarathonPaceSecsPerKm,
                recommendedIntervalPaceSecondsPerKm
            };
        }


        function displayResults(calculations, distanceKm, totalSeconds, hasElevation, useNegativeSplit, originalTimeInputs) {
            // --- Vis Hovedresultater ---
            const formattedAvgActualPace = formatTimeMMSS(calculations.avgActualPaceSecondsPerKm, true);
            const formattedAvgAdjustedPace = formatTimeMMSS(calculations.avgAdjustedPaceSecondsPerKm, true);
            const formattedAvgLapTime = formatTimeMMSS(calculations.avgLapTimeSeconds, false);
            const formattedSpeed = calculations.speedKph.toFixed(2);
            const formattedExact800mTime = formatTimeLong(calculations.exact800mSeconds);
            const formattedExact200mTime = formatTimeLong(calculations.exact200mSeconds);

            paceResultSpan.textContent = `${formattedAvgActualPace} /km`;
            adjustedPaceResultSpan.textContent = `${formattedAvgAdjustedPace} /km`;
            adjustedPaceNoteSpan.textContent = hasElevation ? '(justert for stigning)' : '';
            lapTimeResultSpan.textContent = formattedAvgLapTime;
            speedResultSpan.textContent = `${formattedSpeed} km/t`;
            time800mResultSpan.textContent = formattedExact800mTime;
            time200mResultSpan.textContent = formattedExact200mTime;

            if (useNegativeSplit && distanceKm > 0 && Number.isFinite(calculations.paceFirstHalfSecsPerKm) && Number.isFinite(calculations.paceSecondHalfSecsPerKm)) {
                paceFirstHalfSpan.textContent = formatTimeMMSS(calculations.paceFirstHalfSecsPerKm, true);
                paceSecondHalfSpan.textContent = formatTimeMMSS(calculations.paceSecondHalfSecsPerKm, true);
                negativeSplitPacesInfoDiv.classList.remove('hidden');
            } else {
                negativeSplitPacesInfoDiv.classList.add('hidden');
            }

            // --- Vis Splittider / Løpsplan ---
            if (useNegativeSplit && Number.isFinite(calculations.paceFirstHalfSecsPerKm) && Number.isFinite(calculations.paceSecondHalfSecsPerKm)) {
                generateAndDisplayNegativeSplitPlan(distanceKm, calculations.paceFirstHalfSecsPerKm, calculations.paceSecondHalfSecsPerKm);
            } else {
                generateAndDisplayAverageSplits(distanceKm, calculations.avgActualPaceSecondsPerKm, calculations.avgAdjustedPaceSecondsPerKm);
            }

            // --- Vis Prediksjoner ---
            generateAndDisplayPredictions(distanceKm, calculations.equivalentFlatTotalSeconds);

            // --- Vis Intervalltips ---
            const formattedOriginalTime = formatTimeLong(calculateTotalSeconds(originalTimeInputs));
            const formattedEstimatedHmTime = formatTimeLong(calculations.estimatedHalfMarathonSeconds);
            const formattedEstimatedHmPace = formatTimeMMSS(calculations.estimatedHalfMarathonPaceSecsPerKm, false);
            const formattedRecommendedIntervalPace = formatTimeMMSS(calculations.recommendedIntervalPaceSecondsPerKm, false);

            intervalBasisDistanceSpan.textContent = `${distanceKm.toFixed(2)} km`;
            intervalBasisTimeSpan.textContent = formattedOriginalTime;
            estimatedHmTimeSpan.textContent = formattedEstimatedHmTime;
            estimatedHmPaceSpan.textContent = formattedEstimatedHmPace;
            recommendedIntervalPaceSpan.textContent = formattedRecommendedIntervalPace;

             if (calculations.recommendedIntervalPaceSecondsPerKm > 0 && Number.isFinite(calculations.recommendedIntervalPaceSecondsPerKm)) {
                 intervalSectionDiv.classList.remove('hidden');
             } else {
                 intervalSectionDiv.classList.add('hidden');
             }

            resultsSection.classList.remove('hidden');
        }

        function generateAndDisplayNegativeSplitPlan(distanceKm, paceFirstHalf, paceSecondHalf) {
            splitsListDiv.innerHTML = '';
            splitsTitleText.textContent = "Løpsplan med Negativ Splitt";
            splitsCol2Title.textContent = "Planlagt Pace";
            splitsCol3Title.textContent = "Akkumulert Tid";
            splitsNote.classList.remove('hidden');

            if (distanceKm <= 0 || !Number.isFinite(paceFirstHalf) || !Number.isFinite(paceSecondHalf)) {
                splitsContainer.classList.add('hidden'); return;
            }
            splitsContainer.classList.remove('hidden');

            const halfwayKm = distanceKm / 2;
            let accumulatedSeconds = 0;

            for (let km = 1; km <= Math.ceil(distanceKm); km++) {
                const kmStart = km - 1;
                const kmEnd = Math.min(km, distanceKm);
                const kmDistance = kmEnd - kmStart;
                if (kmDistance <= 0) continue; // Hopp over hvis distansen er 0

                let currentPace;
                if (kmEnd <= halfwayKm) { currentPace = paceFirstHalf; }
                else if (kmStart >= halfwayKm) { currentPace = paceSecondHalf; }
                else {
                    const distFirstHalf = halfwayKm - kmStart;
                    const distSecondHalf = kmEnd - halfwayKm;
                    const timeFirstPart = distFirstHalf * paceFirstHalf;
                    const timeSecondPart = distSecondHalf * paceSecondHalf;
                    currentPace = (timeFirstPart + timeSecondPart) / kmDistance;
                }
                const kmSeconds = kmDistance * currentPace;
                accumulatedSeconds += kmSeconds;
                const formattedPace = formatTimeMMSS(currentPace, true);
                const formattedAccumulatedTime = formatTimeLong(accumulatedSeconds);
                const splitElement = document.createElement('div');
                splitElement.className = 'grid grid-cols-3 gap-2 items-center text-sm p-2 bg-white rounded shadow-xs border border-gray-100';
                splitElement.innerHTML = `
                    <span class="text-left">Km ${kmStart.toFixed(0)}-${kmEnd.toFixed(2)}</span>
                    <strong class="text-center text-indigo-700">${formattedPace}/km</strong>
                    <strong class="text-right text-purple-700">${formattedAccumulatedTime}</strong>
                `;
                splitsListDiv.appendChild(splitElement);
                 if (kmEnd >= distanceKm) break;
            }
        }

        function generateAndDisplayAverageSplits(distanceKm, avgActualPaceSecondsPerKm, avgAdjustedPaceSecondsPerKm) {
            splitsListDiv.innerHTML = '';
            splitsTitleText.textContent = "Estimerte Splittider (per km)";
            splitsCol2Title.textContent = "Faktisk Tid";
            splitsCol3Title.textContent = "Justert Tid (GAP)";
            splitsNote.classList.add('hidden');

            if (distanceKm <= 0 || !Number.isFinite(avgActualPaceSecondsPerKm) || !Number.isFinite(avgAdjustedPaceSecondsPerKm)) {
                 splitsContainer.classList.add('hidden'); return;
            }
             splitsContainer.classList.remove('hidden');
            const fullKms = Math.floor(distanceKm);

            for (let km = 1; km <= fullKms; km++) {
                const actualSplitTimeSeconds = km * avgActualPaceSecondsPerKm;
                const adjustedSplitTimeSeconds = km * avgAdjustedPaceSecondsPerKm;
                const formattedActualSplitTime = formatTimeLong(actualSplitTimeSeconds);
                const formattedAdjustedSplitTime = formatTimeLong(adjustedSplitTimeSeconds);
                const splitElement = document.createElement('div');
                splitElement.className = 'grid grid-cols-3 gap-2 items-center text-sm p-2 bg-white rounded shadow-xs border border-gray-100';
                splitElement.innerHTML = `
                    <span class="text-left">Kilometer ${km}</span>
                    <strong class="text-center text-indigo-700">${formattedActualSplitTime}</strong>
                    <strong class="text-right text-purple-700">${formattedAdjustedSplitTime}</strong>
                `;
                splitsListDiv.appendChild(splitElement);
            }

            if (distanceKm > 0) {
                 const finalActualTimeSeconds = distanceKm * avgActualPaceSecondsPerKm;
                 const finalAdjustedTimeSeconds = distanceKm * avgAdjustedPaceSecondsPerKm;
                 const formattedFinalActualTime = formatTimeLong(finalActualTimeSeconds);
                 const formattedFinalAdjustedTime = formatTimeLong(finalAdjustedTimeSeconds);
                 const splitElement = document.createElement('div');
                 splitElement.className = 'grid grid-cols-3 gap-2 items-center text-sm p-2 bg-white rounded shadow-xs border border-gray-100 font-medium';
                 splitElement.innerHTML = `
                     <span class="text-left">Målgang (${distanceKm.toFixed(2)} km)</span>
                     <strong class="text-center text-indigo-700">${formattedFinalActualTime}</strong>
                     <strong class="text-right text-purple-700">${formattedFinalAdjustedTime}</strong>
                 `;
                 splitsListDiv.appendChild(splitElement);
            } else {
                 splitsContainer.classList.add('hidden');
            }
        }

        function generateAndDisplayPredictions(currentDistanceKm, equivalentFlatTotalSeconds) {
            predictionsGridDiv.innerHTML = '';
            const filteredPredictionDistances = PREDICTION_DISTANCES.filter(dist =>
                Math.abs(dist.value - 0.2) > 0.001 && Math.abs(dist.value - 0.8) > 0.001
            );
            const sortedPredictionDistances = filteredPredictionDistances.sort((a, b) => a.value - b.value);

            sortedPredictionDistances.forEach(targetDistance => {
                 if (Math.abs(targetDistance.value - currentDistanceKm) < 0.001) return;
                 if (equivalentFlatTotalSeconds <= 0 || currentDistanceKm <= 0 || !Number.isFinite(equivalentFlatTotalSeconds)) return; // Ekstra sjekk
                const predictedSeconds = equivalentFlatTotalSeconds * Math.pow(targetDistance.value / currentDistanceKm, RIEGEL_EXPONENT);
                 if (!Number.isFinite(predictedSeconds)) return; // Hopp over hvis prediksjon er ugyldig

                const formattedPredictedTime = formatTimeLong(predictedSeconds);
                const predictionElement = document.createElement('div');
                predictionElement.className = 'prediction-item bg-white p-3 rounded-lg shadow-sm border border-gray-100 text-center transition duration-200 hover:shadow-md';
                predictionElement.innerHTML = `
                    <span class="text-sm text-gray-500 block font-medium">${targetDistance.name}</span>
                    <strong class="text-md font-semibold text-indigo-600 block">${formattedPredictedTime}</strong>
                `;
                predictionsGridDiv.appendChild(predictionElement);
            });
        }


        // --- Hjelpefunksjoner ---
        function formatTimeMMSS(totalSeconds, includeMillis = false) {
            if (!Number.isFinite(totalSeconds)) return "Ugyldig"; // Endret til isFinite
            if (totalSeconds <= 0) return includeMillis ? "0:00.0" : "0:00";
            let minutes = Math.floor(totalSeconds / 60);
            let remainingSeconds = totalSeconds % 60;
            if (remainingSeconds < 0) { remainingSeconds += 60; minutes -= 1; }
            minutes = Math.max(0, minutes);
            const secondsPart = Math.floor(remainingSeconds);
            const millisPart = Math.floor((remainingSeconds - secondsPart) * 10);
            let formattedTime = `${minutes}:${secondsPart < 10 ? '0' : ''}${secondsPart}`;
            if (includeMillis) {
                if (Math.round(remainingSeconds) === 60) return `${minutes + 1}:00.0`;
                formattedTime += `.${Math.max(0, millisPart)}`;
            } else {
                if (Math.round(remainingSeconds) === 60) return `${minutes + 1}:00`;
            }
            return formattedTime;
        }

         function formatTimeLong(totalSeconds) {
             if (!Number.isFinite(totalSeconds)) return "Ugyldig"; // Endret til isFinite
             if (totalSeconds <= 0) return "0:00";
             let hours = Math.floor(totalSeconds / 3600);
             let minutes = Math.floor((totalSeconds % 3600) / 60);
             let seconds = Math.round(totalSeconds % 60);
             if (seconds === 60) { seconds = 0; minutes += 1; }
             if (minutes === 60) { minutes = 0; hours += 1; }
             const formattedMinutes = minutes < 10 ? '0' + minutes : minutes;
             const formattedSeconds = seconds < 10 ? '0' + seconds : seconds;
             if (hours > 0) return `${hours}:${formattedMinutes}:${formattedSeconds}`;
             if (minutes === 0 && hours === 0 && seconds > 0) { return `0:${formattedSeconds}`; }
             if (minutes > 0 || seconds > 0) { return `${minutes}:${formattedSeconds}`; }
             return "0:00";
        }


        function showError(message) { errorMessageDiv.textContent = message; resultsSection.classList.add('hidden'); }
        function clearError() { errorMessageDiv.textContent = ''; }
        function hideResults() {
            resultsSection.classList.add('hidden');
            paceResultSpan.textContent = ''; adjustedPaceResultSpan.textContent = '';
            adjustedPaceNoteSpan.textContent = ''; lapTimeResultSpan.textContent = '';
            speedResultSpan.textContent = ''; time800mResultSpan.textContent = '';
            time200mResultSpan.textContent = '';
            negativeSplitPacesInfoDiv.classList.add('hidden');
            splitsListDiv.innerHTML = ''; predictionsGridDiv.innerHTML = '';
            splitsNote.classList.add('hidden');
            intervalBasisDistanceSpan.textContent = ''; intervalBasisTimeSpan.textContent = '';
            estimatedHmTimeSpan.textContent = ''; estimatedHmPaceSpan.textContent = '';
            recommendedIntervalPaceSpan.textContent = '';
            intervalSectionDiv.classList.add('hidden');
        }

        // Initialiser
        handleDistanceChange();

    </script>

</body>
</html>
